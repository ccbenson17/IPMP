<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: widgets/Treatment/Widget.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: widgets/Treatment/Widget.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview
 * (Custom Widget - {@link module:Treatment|More info}) Treatment provides an interface for selecting points from the rawdata FeatureSet, and calculates cost estimates for projects based on the selection. On open, it hides current layers, and makes the rawdata featureSet visible on the map.
 */
/*global define, console, setTimeout*/
define([
	//dojo
	'dojo/_base/declare',
	'jimu/BaseWidget',
	'dijit/_WidgetsInTemplateMixin',
	'dijit/form/Button',
	'dojo/on',
	'dojo/dom',
	'dojo/aspect',
	'dijit/form/SimpleTextarea',
	'dojo/dom-class',
	'dojo/_base/array',
	'dojo/string',
	'dojo/_base/lang',
	'dojo/Deferred',
	'dojo/promise/all',

	'esri/map',
	'esri/tasks/StatisticDefinition',
	'esri/toolbars/draw',
	'esri/graphic',

	//esri
	'jimu/WidgetManager',
	'jimu/PanelManager',
	'esri/config',
	'esri/InfoTemplate',
	'esri/geometry/Point',
	'esri/geometry/Extent',
	'esri/tasks/query',
	'esri/tasks/QueryTask',
	'esri/symbols/SimpleLineSymbol',
	'esri/symbols/SimpleFillSymbol',
	'esri/symbols/SimpleMarkerSymbol',
	'esri/layers/FeatureLayer',
	'esri/request',
	'esri/InfoTemplate',
	'dojo/promise/all',
	'dojo/dom-class',
	'esri/lang',
	'jimu/dijit/LoadingShelter',
	'esri/Color',
	'dijit/registry',
	'esri/plugins/FeatureLayerStatistics',
	'jimu/WidgetManager',
	'dojo/domReady!',
], function (
	//dojo
	declare,
	BaseWidget,
	_WidgetsInTemplateMixin,
	Button,
	on,
	dom,
	aspect,
	SimpleTextarea,
	domClass,
	array,
	dojoString,
	lang,
	Deferred,
	all,

	Map,
	StatisticDefinition,
	Draw,
	Graphic,

	//esri
	WidgetManager,
	PanelManager,
	esriConfig,
	InfoTemplate,
	Point,
	Extent,
	Query,
	QueryTask,
	SimpleLineSymbol,
	SimpleFillSymbol,
	SimpleMarkerSymbol,
	FeatureLayer,
	esriRequest,
	InfoTemplate,
	all,
	domClass,
	esriLang,
	LoadingShelter,
	Color,
	registry,
	FeatureLayerStatistics,
	WidgetManager
) {
	/**
	 * @module Treatment
	 */
	return declare([BaseWidget, _WidgetsInTemplateMixin], {
		// DemoWidget code goes here

		//please note that this property is be set by the framework when widget is loaded.
		//templateString: template,

		baseClass: 'jimu-widget-PickColumns',
		name: 'PickColumns',
		label: 'PickColumns',

		selectedYear: null,
		oldFeature: null,
		selectionToolbar: null,
		fieldsSelectionSymbol: null,
		content: null,
		infoTemplate: null,
		featureLayer: null,
		selectQuery: null,
		query: null,
		loaderWidget: null,
		badQuery: null,
		recursionBind: null,

		postCreate: function () {
			this.inherited(arguments);
			console.log('postCreate');
		},

		/**
		 * On startup, the Treatment Widget hides all current layers from the map, and adds the points (rawdata) layer. This Widget provides functionality to select a region of points, and provide cost analysis on the selected data.
		 */
		startup: function () {
			this.inherited(arguments);

			// on(this.selectYR, "change", ev => {
			//   this.setActiveLayer();
			// });

			this.fieldsSelectionSymbol = new SimpleFillSymbol(
				SimpleFillSymbol.STYLE_SOLID,
				new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color('#00ffff'), 2),
				new Color([255, 255, 0, 0.5])
			);

			this.selectQuery = new Query();
			// selectQuery.distance = 16;  // Return all segments within 16m of the point
			//selectQuery.units = "meters";
			this.selectQuery.outFields = ['*'];
			this.initSelectToolbar();

			on(dom.byId('selectFieldsButton'), 'click', (ev) => {
				this.selectionToolbar.activate(Draw.EXTENT);
			});

			on(dom.byId('clearSelectionButton'), 'click', (ev) => {
				dom.byId('IriResult').innerHTML = ' ';
				dom.byId('RutResult').innerHTML = ' ';
				dom.byId('LongResult').innerHTML = ' ';
				dom.byId('TransResult').innerHTML = ' ';
				dom.byId('AlligResult').innerHTML = ' ';
				dom.byId('DcrackResult').innerHTML = ' ';
				dom.byId('JspallResult').innerHTML = ' ';
				dom.byId('sumLengthResult').innerHTML = '&lt;i>No Selected Fields&lt;/i>';
				dom.byId('colYear').innerHTML = ' ';

				//dom.byId("clearSelectionButton").disabled = true;
			});

			this.own(
				on(
					this.selectionToolbar,
					'DrawEnd',
					lang.hitch(this, function (geometry) {
						if (this.featureLayer) {
							this.selectionToolbar.deactivate();
							this.selectQuery.geometry = geometry;
							this.featureLayer.selectFeatures(this.selectQuery, FeatureLayer.SELECTION_NEW);
						}
					})
				)
			);

			document.getElementById('pave_type').value = 'PCC';

			this.loaderWidget = WidgetManager.getInstance().getWidgetByLabel('MapProgress');
			this.recursionBind = 0;
		},

		/**
		 * Draws the PCI Line layer on map
		 * @param {*} featureSet The result of the query from https://ipmp.ctre.iastate.edu/arcgis/rest/services/aphares/March/MapServer/
		 */
		setLayer: function (featureSet) {
			if (this.featureLayer) {
				this.map.removeLayer(this.map.getLayer('Treatment'));
				this.featureLayer = null;
			}

			// This, when map on layer has correct fields: this.featureLayer = this.map.getLayer(this.selectedYear)
			var resultFeatures = featureSet.features;

			if (resultFeatures.length === 0) {
				alert('No results found.');
			} else {
				//this.map.graphics.clear();
				var geometryTypeQuery = featureSet.geometryType;

				var symbolQuery = new SimpleMarkerSymbol(
					new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 20, new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color([0, 0, 205, 1]), 1), new Color([0, 0, 205, 0.5]))
				);

				//create a feature collection
				var featureCollection = {
					layerDefinition: null,
					featureSet: {
						features: [],
						geometryType: geometryTypeQuery,
					},
				};

				featureCollection.layerDefinition = {
					geometryType: geometryTypeQuery,
					drawingInfo: {
						renderer: {
							type: 'simple',
							symbol: symbolQuery.toJson(),
						},
					},
					fields: featureSet.fields,
				};

				var fieldsSelectionSymbol = (this.featureLayer = new FeatureLayer(featureCollection, {
					id: 'Treatment',
					infoTemplate: window.myInfoTemplate,
					mode: FeatureLayer.MODE_ON_DEMAND,
					hasGeometryProperties: true,
					outFields: ['*'],
				}));

				//loop though the features
				var color, pci;
				for (var i = 0, len = resultFeatures.length; i &lt; len; i++) {
					var feature = resultFeatures[i];
					pci = feature.attributes['PCI'];

					if (pci &lt;= 20) {
						color = 'red';
					} else if (pci &lt;= 40) {
						color = 'orange';
					} else if (pci &lt;= 60) {
						color = 'yellow';
					} else if (pci &lt;= 80) {
						color = 'green';
					} else {
						color = 'blue';
					}

					feature.setSymbol(new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 10, new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(color), 1), new Color(color)));
					this.featureLayer.add(feature);
				}

				// //loop though the features
				// for (var i = 0, len = resultFeatures.length; i &lt; len; i++) {
				//   var feature = resultFeatures[i];
				//   feature.setSymbol(symbolQuery);
				//   this.featureLayer.add(feature);
				// }
			}

			this.map.addLayer(this.featureLayer);
			this.loaderWidget.showOrHide(0, false);
		},

		setActiveLayer: function () {
			if (this.featureLayer) {
				// this.selectQuery.geometry = null;
				// this.featureLayer.selectFeatures(this.badQuery, FeatureLayer.SELECTION_NEW);
			}
			// if (this.oldFeature) {
			//   // This will probably cause a lot of issues, but there's no deep copy method for a featureLayer object, which comes as a great surprise from esri.
			//   this.map.removeLayer(this.map.getLayer(this.selectedYear));
			//   this.featureLayer = this.oldFeature;
			//   this.featureLayer.on("selection-complete", ev => function() {});
			//   this.featureLayer.on("selection-clear", ev => function() {});
			//   //this.featureLayer.setDefinitionExpression(null);
			//   //this.featureLayer.setSelectionSymbol(null);
			//   this.map.addLayer(this.featureLayer);
			// }
			var id = this.selectYR.get('value');
			switch (parseInt(id)) {
				case 1:
					this.selectedYear = '2018';
					break;
				case 2:
					this.selectedYear = '2017';
					break;
				case 3:
					this.selectedYear = '2016';
					break;
				case 4:
					this.selectedYear = '2015';
					break;
				case 5:
					this.selectedYear = '2014';
					break;
				case 6:
					this.selectedYear = '2013';
					break;
			}
			this.featureLayer = this.map.getLayer(this.selectedYear);
			this.oldFeature = Object.assign({}, this.featureLayer._graphicsVal);
			this.recursionBind = 0;

			this.featureLayer.setDefinitionExpression('PCI >= 0');
			this.featureLayer.setSelectionSymbol(this.fieldsSelectionSymbol);

			this.loaderWidget.showOrHide(0, false);
		},

		/**
		 * Determines if the given variable is of object type.
		 * @param {*} obj the variable to test
		 */
		isObject: function (obj) {
			var type = typeof obj;
			return type === 'function' || (type === 'object' &amp;&amp; !!obj);
		},

		/**
		 * Performs an iterative clone of the given object.
		 * @param {*} src the object to copy
		 */
		iterationCopy: function (src) {
			let target = {};
			this.recursionBind++;
			for (let prop in src) {
				if (src.hasOwnProperty(prop)) {
					// if the value is a nested object, recursively copy all it's properties
					if (this.isObject(src[prop]) &amp;&amp; this.recursionBind &lt; 100) {
						target[prop] = this.iterationCopy(src[prop]);
					} else {
						target[prop] = src[prop];
					}
				}
			}
			return target;
		},

		initSelectToolbar: function () {
			this.selectionToolbar = new Draw(this.map);
		},

		/**
		 * Contains the calculations for performing cost analysis on the selected points.
		 * @param {FeatureLayer} result The elements selected by user.
		 */
		getStats: function (result) {
			results = result.features;
			// The return object of the query containing the statistics requested
			console.log(`Contained ${results.length}`);
			if (!results.length) {
				dom.byId('msgs').innerHTML = 'No items selected.';
				return;
			}
			document.getElementById('clearSelectionButton').disabled = false;

			var stats = results[0].attributes;
			var PaveType = results[0].attributes.PAVE_TYPE;

			// get date to use to query which year to use
			var maxTime = 0;
			var iri = 0;
			var rut = 0;
			var long = 0;
			var trans = 0;
			var allig = 0;
			var dcrack = 0;
			var jspall = 0;
			var lgth = 0;
			var pava = PaveType;

			let length = results.length;
			for (let i = 0; i &lt; length - 1; i++) {
				stats = results[i].attributes;
				if (maxTime &lt; stats.MAX_DATE) maxTime = stats.MAX_DATE;
				iri += stats.IRI;
				rut += (stats.AVG_LRUT + stats.AVG_RRUT) / 2;
				long += ((stats.LONG_L + stats.LONG_M + stats.LONG_H + stats.LONG_WP_L + stats.LONG_WP_M + stats.LONG_WP_H) / 5280) * stats.CALC_LGTH;
				trans += (((stats.TRANS_L + stats.TRANS_M + stats.TRANS_H) * 9.02) / 5280) * stats.CALC_LGTH;
				allig += (((stats.ALLIG_M + stats.ALLIG_H) * 24) / (stats.CALC_LGTH * 24)) * 100;
				dcrack += ((stats.DCRACK_M + stats.DCRACK_H) / 264) * (stats.CALC_LGTH / 20);
				jspall += ((stats.JSPALL_M + stats.JSPALL_H) / 264) * (stats.CALC_LGTH / 20);
				lgth += stats.CALC_LGTH / 5280;
			}
			iri = iri / length;
			rut = rut / length;

			// Print the statistic results to the DOM
			dom.byId('IriResult').innerHTML = Math.round(iri) + ' in/mi';
			dom.byId('RutResult').innerHTML = rut.toFixed(3) != 'NaN' ? rut.toFixed(3) + +' in' : 'No data';
			dom.byId('LongResult').innerHTML = long.toFixed(2) + ' ft/mi';
			dom.byId('TransResult').innerHTML = trans.toFixed(2) + ' ft/mi';
			dom.byId('AlligResult').innerHTML = allig.toFixed(2) + ' %';
			dom.byId('DcrackResult').innerHTML = dcrack.toFixed(2) + ' count/mi';
			dom.byId('JspallResult').innerHTML = jspall.toFixed(2) != 'NaN' ? jspall.toFixed(2) + ' count/mi' : 'No data';
			dom.byId('sumLengthResult').innerHTML = lgth.toFixed(2) + ' mi';
			dom.byId('colYear').innerHTML = stats.YEAR;

			var select_id = document.getElementById('pave_type');

			if (select_id.options[select_id.selectedIndex].value == 'PCC') {
				window.tempRef.PCCtreatments(long, trans, dcrack, jspall, lgth);
			} else {
				window.tempRef.ACCtreatments(rut, long, trans, allig, lgth);
			}
		},

		/**
		 * Additional cost estimate for when ACC is selected from Pavement menu
		 * @param {long} rut2 average rut from selected points
		 * @param {long} long3 average long from selected points
		 * @param {long} trans4 average trans from selected points
		 * @param {long} allig average allig from selected points
		 * @param {long} pmlgth  	average pmlgth from selected points
		 */
		ACCtreatments: function (rut2, long3, trans4, allig, pmlgth) {
			var i = 0;
			options = [];
			var strategy = {};
			var arrayLength = options.length;
			if ((allig > 5 &amp;&amp; long3 > 5279) || trans4 > 1583 || rut2 > 0.26) {
				strategy = {
					title: 'Thick HMA OVERLAY',
					cost: pmlgth * 280000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (allig > 0 &amp;&amp; rut2 > 0.26 &amp;&amp; (long3 > 5279 || trans4 > 1583)) {
				strategy = {
					title: 'Milling &amp; Overlay',
					cost: pmlgth * 120000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (rut2 > 0.26 &amp;&amp; (long3 > 5279 || trans4 > 1583)) {
				strategy = {
					title: 'Cold in Place Recycling',
					cost: pmlgth * 100000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (rut2 > 0.26 &amp;&amp; (long3 > 5279 || trans4 > 1583)) {
				strategy = {
					title: 'Mill &amp; Overlay with Cold in Place Recycling',
					cost: pmlgth * 150000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (long3 > 5279 &amp;&amp; trans4 > 1583) {
				strategy = {
					title: 'Whitetopping',
					cost: pmlgth * 300000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (rut2 > 0.26) {
				strategy = {
					title: 'Milling only',
					cost: pmlgth * 10000,
					remarks: 'Minor',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (long3 &lt; 2040 &amp;&amp; trans4 &lt; 792) {
				strategy = {
					title: 'Thin HMA Overlay',
					cost: pmlgth * 52000,
					remarks: 'Minor',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (rut2 &lt; 0.26 &amp;&amp; long3 > 500 &amp;&amp; long3 &lt; 2640 &amp;&amp; trans4 > 100 &amp;&amp; trans4 &lt; 792) {
				strategy = {
					title: 'Chip Seal',
					cost: pmlgth * 22000,
					remarks: 'Minor',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}
			if (rut2 &lt; 0.26 &amp;&amp; long3 > 500 &amp;&amp; long3 &lt; 2640 &amp;&amp; trans4 > 100 &amp;&amp; trans4 &lt; 792) {
				strategy = {
					title: 'Microsurfacing',
					cost: pmlgth * 45000,
					remarks: 'Minor',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}
			if (rut2 &lt; 0.26 &amp;&amp; (long3 &lt; 2640 || trans4 &lt; 792)) {
				strategy = {
					title: 'Milling and Chip Seal',
					cost: pmlgth * 26000,
					remarks: 'Minor',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}
			if ((long3 > 100 &amp;&amp; long3 &lt; 2640) || (trans4 > 50 &amp;&amp; trans4 &lt; 792)) {
				strategy = {
					title: 'Crack Seal/Fill',
					cost: pmlgth * 5280,
					remarks: 'Preservation',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			if (allig > 0 &amp;&amp; (long3 &lt; 2040 || trans4 &lt; 792)) {
				strategy = {
					title: 'Patching',
					cost: pmlgth * 30000,
					remarks: 'Localized',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '    ' + strategy.remarks;
				i++;
			}

			// loop through the array to append child to the innerHTML based on array length

			var content;
			arrayLength = options.length;
			//if array empty
			if (arrayLength &lt; 1) {
				// insertAdjacentHTML() parses the specified text as HTML or XML and inserts the resulting nodes into the DOM tree at a specified position.

				dom.byId('msgs').innerHTML = 'No treatments proposed.';
				// dom.byId("msgs").innerHTML = arrayLength;
			}

			// else loop through the array to append child to the innerHTML based on array length
			else {
				dom.byId('msgs').innerHTML = "&lt;div id='container'>&lt;/div>";
				var div_treat = dom.byId('container');
				for (var t = 0; t &lt; arrayLength; t++) {
					// this preserves the current html while adding to it
					var position = t + 1;
					div_treat.insertAdjacentHTML('beforeend', '&lt;strong>Option ' + position + ":&lt;/strong>&lt;span class = 'stats'>" + options[t] + '&lt;/span>&lt;br>');
				}
			}
			//dom.byId("treat1").innerHTML = PaveType;
			// dom.byId("treat2").innerHTML = options[1];
			// dom.byId("treat3").innerHTML = options[2];

			dom.byId('treatments').style.display = 'block';
		},

		PCCtreatments: function (long5, trans6, dcrk, jsp, pmlgth) {
			var i = 0;
			options = [];
			var strategy = {};
			var arrayLength = options.length;
			if (long5 > 1319 &amp;&amp; trans6 > 791) {
				strategy = {
					title: 'Thick HMA OVERLAY with Crack and Seat',
					cost: pmlgth * 280000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '-------- $' + Math.round(strategy.cost) + '------------ ' + strategy.remarks;
				i++;
			}

			if (long5 > 1319 &amp;&amp; trans6 > 791) {
				strategy = {
					title: 'Thick HMA OVERLAY with Rubblization',
					cost: pmlgth * 200000,
					remarks: 'Major',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '          ' + strategy.remarks;
				i++;
			}

			if (long5 > 1319 || (trans6 > 791 &amp;&amp; (dcrk &lt; 5 || jsp &lt; 5))) {
				strategy = {
					title: 'Full Depth Repair',
					cost: pmlgth * 125000,
					remarks: 'Localized',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '         ' + strategy.remarks;
				i++;
			}

			if (trans6 > 791) {
				strategy = {
					title: 'Slab Replacement',
					cost: pmlgth * 100000,
					remarks: 'Localized',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '        ' + strategy.remarks;
				i++;
			}

			if ((long5 &lt; 1319 &amp;&amp; long5 > 300) || (trans6 &lt; 791 &amp;&amp; trans6 > 200)) {
				strategy = {
					title: 'Crack Sealing',
					cost: pmlgth * 5280,
					remarks: 'Preservation',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '       ' + strategy.remarks;
				i++;
			}

			if (long5 &lt; 500 || trans6 &lt; 300) {
				strategy = {
					title: 'Do Nothing',
					cost: 0,
					remarks: 'No treatment proposed',
				};
				options[i] = strategy.title + '    $' + Math.round(strategy.cost) + '       ' + strategy.remarks;
				i++;
			}

			// loop through the array to append child to the innerHTML based on array length

			var content;
			arrayLength = options.length;
			//if array empty
			if (arrayLength &lt; 1) {
				// insertAdjacentHTML() parses the specified text as HTML or XML and inserts the resulting nodes into the DOM tree at a specified position.

				dom.byId('msgs').innerHTML = 'No treatments proposed.';
				// dom.byId("msgs").innerHTML = arrayLength;
			}

			// else loop through the array to append child to the innerHTML based on array length
			else {
				dom.byId('msgs').innerHTML = "&lt;div id='container'>&lt;/div>";
				var div_treat = dom.byId('container');
				for (var t = 0; t &lt; arrayLength; t++) {
					// this preserves the current html while adding to it
					var position = t + 1;
					div_treat.insertAdjacentHTML('beforeend', '&lt;strong>Option ' + position + ":&lt;/strong>&lt;span class = 'stats'>" + options[t] + '&lt;/span>&lt;br>');
				}
			}
			//dom.byId("treat1").innerHTML = PaveType;
			// dom.byId("treat2").innerHTML = options[1];
			// dom.byId("treat3").innerHTML = options[2];

			dom.byId('treatments').style.display = 'block';
		},

		onReceiveData: function (name, widgetId, data, historyData) {
			console.log('Received data from ' + name + ' with data equal to: ' + data);
			if (name == 'Splash' &amp;&amp; (window.isSplash || data.target != 'AttributeTable')) {
				console.log('treatment - received ' + data);
				// this.setYearWhere()
				// //filter out messages
				if (widgetId != 'Splash_T') {
					this.query = historyData[historyData.length - 1].value; // I'm assuming nothing else is using the data manager and know that query is at index 0
				} else {
					this.query = data;
				}
				this.query.returnDistinctValues = false;
				this.query.returnGeometry = true;
			}
		},

		removestuffs: function (testDiv) {
			testDiv.style.display = 'none';
			while (testDiv.hasChildNodes()) testDiv.removeChild(testDiv.lastChild);
			testDiv.style.display = display;
		},

		errback: function (err) {
			console.log("Couldn't retrieve summary statistics. ", err);
		},

		onOpen: function () {
			// var y = dom.byId("selectFieldsButton");
			// y.setDisabled(true);
			// var x = dom.byId("clearSelectionButton");
			// x.setDisabled(true);
			console.log('onOpen');
			this.map.graphicsLayerIds.forEach((id) => {
				this.map.getLayer(id).hide();
			});
			// Get rawdata -- called mapservice19_4526 as named in this.map.graphicLayerIds
			this.featureLayer = this.map.getLayer('mapservice19_4526');
			if (this.featureLayer) {
				this.featureLayer.show();
				this.featureLayer.on('selection-complete', this.getStats);
			}
			window.tempRef = this;
		},

		onClose: function () {
			window.tempRef = null;
			this.map.graphicsLayerIds.forEach((id) => {
				this.map.getLayer(id).show();
			});
			if (this.map.getLayer('mapservice19_4526')) this.map.getLayer('mapservice19_4526').hide();
			if (this.featureLayer) {
				//this.map.removeLayer(this.map.getLayer("Treatment"));
				this.featureLayer = null;
			}
			console.log('onClose');
		},

		onMinimize: function () {
			console.log('onMinimize');
		},

		onMaximize: function () {
			console.log('onMaximize');
		},

		onSignIn: function (credential) {
			/* jshint unused:false*/
			console.log('onSignIn');
		},

		onSignOut: function () {
			console.log('onSignOut');
		},
	});
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="echarts_coord_scale_Ordinal%250D%250Dhttp___en.wikipedia.org_wiki_Level_of_measurementmodule_.html">echarts/coord/scale/Ordinalhttp://en.wikipedia.org/wiki/Level_of_measurement</a></li><li><a href="echarts-module_ECharts.html">ECharts</a></li><li><a href="echarts-module_MessageCenter.html">MessageCenter</a></li><li><a href="module-AttributeTable.html">AttributeTable</a></li><li><a href="module-BasemapGallery.html">BasemapGallery</a></li><li><a href="module-Draw.html">Draw</a></li><li><a href="module-echarts_animation_Animator.html">echarts/animation/Animator</a></li><li><a href="module-echarts_chart_helper_Line.html">echarts/chart/helper/Line</a></li><li><a href="module-echarts_chart_helper_LineDraw.html">echarts/chart/helper/LineDraw</a></li><li><a href="module-echarts_chart_helper_Symbol.html">echarts/chart/helper/Symbol</a></li><li><a href="module-echarts_chart_helper_SymbolDraw.html">echarts/chart/helper/SymbolDraw</a></li><li><a href="module-echarts_coord_Cartesian.html">echarts/coord/Cartesian</a></li><li><a href="module-echarts_coord_geo_parseGeoJson.html">echarts/coord/geo/parseGeoJson</a></li><li><a href="module-echarts_coord_geo_Region.html">echarts/coord/geo/Region</a></li><li><a href="module-echarts_core_BoundingRect.html">echarts/core/BoundingRect</a></li><li><a href="module-echarts_data_List.html">echarts/data/List</a></li><li><a href="module-echarts_model_Component.html">echarts/model/Component</a></li><li><a href="module-echarts_model_Model.html">echarts/model/Model</a></li><li><a href="module-echarts_scale_Interval.html">echarts/scale/Interval</a></li><li><a href="module-echarts_scale_Log.html">echarts/scale/Log</a></li><li><a href="module-echarts_scale_Scale.html">echarts/scale/Scale</a></li><li><a href="module-echarts_stream_Scheduler.html">echarts/stream/Scheduler</a></li><li><a href="module-Geoprocessing.html">Geoprocessing</a></li><li><a href="module-HomeButton.html">HomeButton</a></li><li><a href="module-Infographic.html">Infographic</a></li><li><a href="module-LayerList.html">LayerList</a></li><li><a href="module-MapProgress.html">MapProgress</a></li><li><a href="module-PickColumns.html">PickColumns</a></li><li><a href="module-Search.html">Search</a></li><li><a href="module-Select.html">Select</a></li><li><a href="module-Splash.html">Splash</a></li><li><a href="module-themes_LaunchpadTheme_widgets_AnchorBarController_BaseIconItem.html">themes/LaunchpadTheme/widgets/AnchorBarController/BaseIconItem</a></li><li><a href="module-themes_LaunchpadTheme_widgets_AnchorBarController_DockableItem.html">themes/LaunchpadTheme/widgets/AnchorBarController/DockableItem</a></li><li><a href="module-themes_LaunchpadTheme_widgets_AnchorBarController_GroupItems.html">themes/LaunchpadTheme/widgets/AnchorBarController/GroupItems</a></li><li><a href="module-themes_LaunchpadTheme_widgets_AnchorBarController_Widget.html">themes/LaunchpadTheme/widgets/AnchorBarController/Widget</a></li><li><a href="module-Treatment.html">Treatment</a></li><li><a href="module-widgets_Coordinate.html">widgets/Coordinate</a></li><li><a href="module-zrender_animation_Animation.html">zrender/animation/Animation</a></li><li><a href="module-zrender_animation_easing.html">zrender/animation/easing</a></li><li><a href="module-zrender_core_bbox.html">zrender/core/bbox</a></li><li><a href="module-zrender_core_curve.html">zrender/core/curve</a></li><li><a href="module-zrender_core_event.html">zrender/core/event</a></li><li><a href="module-zrender_core_PathProxy.html">zrender/core/PathProxy</a></li><li><a href="module-zrender_core_util.html">zrender/core/util</a></li><li><a href="module-zrender_graphic_Displayable.html">zrender/graphic/Displayable</a></li><li><a href="module-zrender_graphic_Group.html">zrender/graphic/Group</a></li><li><a href="module-zrender_graphic_shape_Arc.html">zrender/graphic/shape/Arc</a></li><li><a href="module-zrender_graphic_shape_Line.html">zrender/graphic/shape/Line</a></li><li><a href="module-zrender_graphic_shape_Polyline.html">zrender/graphic/shape/Polyline</a></li><li><a href="module-zrender_graphic_shape_Rect.html">zrender/graphic/shape/Rect</a></li><li><a href="module-zrender_graphic_shape_Ring.html">zrender/graphic/shape/Ring</a></li><li><a href="module-zrender_graphic_shape_Sector.html">zrender/graphic/shape/Sector</a></li><li><a href="module-zrender_Layer.html">zrender/Layer</a></li><li><a href="module-zrender_mixin_Eventful.html">zrender/mixin/Eventful</a></li><li><a href="module-zrender_mixin_RectText.html">zrender/mixin/RectText</a></li><li><a href="module-zrender_mixin_Transformable.html">zrender/mixin/Transformable</a></li><li><a href="module-zrender_shape_BezierCurve.html">zrender/shape/BezierCurve</a></li><li><a href="module-zrender_shape_Circle.html">zrender/shape/Circle</a></li><li><a href="module-zrender_shape_Polygon.html">zrender/shape/Polygon</a></li><li><a href="module-zrender_shape_util_smoothBezier.html">zrender/shape/util/smoothBezier</a></li><li><a href="module-zrender_shape_util_smoothSpline.html">zrender/shape/util/smoothSpline</a></li><li><a href="module-zrender_tool_matrix.html">zrender/tool/matrix</a></li><li><a href="module-zrender_ZRender.html">zrender/ZRender</a></li><li><a href="module-%257Becharts_model_Global%257D.html">{echarts/model/Global}</a></li><li><a href="module-%257Becharts_model_OptionManager%257D.html">{echarts/model/OptionManager}</a></li></ul><h3>Namespaces</h3><ul><li><a href="crc.html">crc</a></li><li><a href="LocalMediaStream%2520--%2520https___developer.mozilla.org_en-US_docs_WebRTC_MediaStream_API_LocalMediaStream.html">LocalMediaStream</a></li><li><a href="xhr.sendAsBinary%2520%2520https___developer.mozilla.org_ru_XMLHttpRequest_Sending_binary_content.html">Sending_binary_content</a></li></ul><h3>Classes</h3><ul><li><a href="FileAPI.Camera.html">Camera</a></li><li><a href="FileAPI.Camera.Shot.html">Shot</a></li><li><a href="modue_zrender_mixin_Animatable.html">modue:zrender/mixin/Animatable</a></li><li><a href="module-echarts_chart_helper_SymbolDraw.html">echarts/chart/helper/SymbolDraw</a></li><li><a href="module-echarts_component_marker_LineDraw.html">echarts/component/marker/LineDraw</a></li><li><a href="module-echarts_component_tooltip_TooltipContent.html">echarts/component/tooltip/TooltipContent</a></li><li><a href="module-echarts_coord_Cartesian.html">echarts/coord/Cartesian</a></li><li><a href="module-echarts_coord_Cartesian-module_echarts_coord_cartesian_Axis2D.html">echarts/coord/cartesian/Axis2D</a></li><li><a href="module-echarts_coord_scale_Interval.html">echarts/coord/scale/Interval</a></li><li><a href="module-echarts_coord_scale_Time.html">echarts/coord/scale/Time</a></li><li><a href="module-echarts_data_List.html">echarts/data/List</a></li><li><a href="module-echarts_model_Component.html">echarts/model/Component</a></li><li><a href="module-echarts_model_Model.html">echarts/model/Model</a></li><li><a href="module-zrender_animation_Animation.html">zrender/animation/Animation</a></li><li><a href="module-zrender_animation_Animator.html">zrender/animation/Animator</a></li><li><a href="module-zrender_core_LRU.html">zrender/core/LRU</a></li><li><a href="module-zrender_core_PathProxy.html">zrender/core/PathProxy</a></li><li><a href="module-zrender_Element.html">zrender/Element</a></li><li><a href="module-zrender_graphic_Group.html">zrender/graphic/Group</a></li><li><a href="module-zrender_graphic_Path.html">zrender/graphic/Path</a></li><li><a href="module-zrender_Handler.html">zrender/Handler</a></li><li><a href="module-zrender_Layer.html">zrender/Layer</a></li><li><a href="module-zrender_mixin_Eventful.html">zrender/mixin/Eventful</a></li><li><a href="module-zrender_mixin_Transformable.html">zrender/mixin/Transformable</a></li><li><a href="module-zrender_Painter.html">zrender/Painter</a></li><li><a href="module-zrender_Storage.html">zrender/Storage</a></li><li><a href="module-zrender_ZRender.html">zrender/ZRender</a></li><li><a href="zrender_graphic_Image.html">zrender/graphic/Image</a></li><li><a href="zrender_graphic_Text.html">zrender/graphic/Text</a></li><li>{<a href="module-echarts_chart_helper_Line.html">module:echarts/chart/helper/Line</a>}</li><li>{<a href="module-echarts_chart_helper_Symbol.html">module:echarts/chart/helper/Symbol</a>}</li></ul><h3>Events</h3><ul><li><a href="module-echarts_chart_helper_SymbolDraw.html#~event:legendScroll">legendScroll</a></li><li><a href="module-echarts_chart_helper_SymbolDraw.html#~event:legendSelect">legendSelect</a></li><li><a href="module-echarts_chart_helper_SymbolDraw.html#~event:legendToggleSelect">legendToggleSelect</a></li><li><a href="module-echarts_chart_helper_SymbolDraw.html#~event:legendUnSelect">legendUnSelect</a></li></ul><h3>Mixins</h3><ul><li><a href="module-echarts_chart_helper_LineDraw-%257Bmodule_zrender_mixin_Eventful%257D.html">{zrender/mixin/Eventful}</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_addExternalStyleSheets">_addExternalStyleSheets</a></li><li><a href="global.html#_addSectionTitle">_addSectionTitle</a></li><li><a href="global.html#_createLayout">_createLayout</a></li><li><a href="global.html#_createPrintMapParameters">_createPrintMapParameters</a></li><li><a href="global.html#_createPrintTask">_createPrintTask</a></li><li><a href="global.html#_createReportNote">_createReportNote</a></li><li><a href="global.html#_displayLayers">_displayLayers</a></li><li><a href="global.html#_executePrintTask">_executePrintTask</a></li><li><a href="global.html#_filters">_filters</a></li><li><a href="global.html#_findContentItemById">_findContentItemById</a></li><li><a href="global.html#_formatAndRenderTables">_formatAndRenderTables</a></li><li><a href="global.html#_getFixedThemeStyles">_getFixedThemeStyles</a></li><li><a href="global.html#_handleDataSourceForWidgets">_handleDataSourceForWidgets</a></li><li><a href="global.html#_onAppProxyForMapChanged">_onAppProxyForMapChanged</a></li><li><a href="global.html#_onAppProxyForUrlChanged">_onAppProxyForUrlChanged</a></li><li><a href="global.html#_onFieldVisibleChange">_onFieldVisibleChange</a></li><li><a href="global.html#_renderHTMLData">_renderHTMLData</a></li><li><a href="global.html#_renderTable">_renderTable</a></li><li><a href="global.html#_resetCoordinate">_resetCoordinate</a></li><li><a href="global.html#_setButtonLabels">_setButtonLabels</a></li><li><a href="global.html#_setCoordControlsTabindex">_setCoordControlsTabindex</a></li><li><a href="global.html#_setFootNotes">_setFootNotes</a></li><li><a href="global.html#_setPageSize">_setPageSize</a></li><li><a href="global.html#_setReportData">_setReportData</a></li><li><a href="global.html#_setReportLogo">_setReportLogo</a></li><li><a href="global.html#_setReportSizeMessage">_setReportSizeMessage</a></li><li><a href="global.html#_setReportTitle">_setReportTitle</a></li><li><a href="global.html#_updatePartForBetween">_updatePartForBetween</a></li><li><a href="global.html#_validateParameters">_validateParameters</a></li><li><a href="global.html#acceptValue">acceptValue</a></li><li><a href="global.html#action">action</a></li><li><a href="global.html#applyWidgetFilter">applyWidgetFilter</a></li><li><a href="global.html#calculateLayerIndex">calculateLayerIndex</a></li><li><a href="global.html#canAssignUsersToOrgGroups">canAssignUsersToOrgGroups</a></li><li><a href="global.html#canChangeUserRoles">canChangeUserRoles</a></li><li><a href="global.html#canCreateGroup">canCreateGroup</a></li><li><a href="global.html#canCreateItem">canCreateItem</a></li><li><a href="global.html#canDeleteOrgGroups">canDeleteOrgGroups</a></li><li><a href="global.html#canDeleteOrgItems">canDeleteOrgItems</a></li><li><a href="global.html#canDeleteUsers">canDeleteUsers</a></li><li><a href="global.html#canDesignateOpenDataGroups">canDesignateOpenDataGroups</a></li><li><a href="global.html#canDisableUsers">canDisableUsers</a></li><li><a href="global.html#canEditFeatures">canEditFeatures</a></li><li><a href="global.html#canEditFeaturesFullControl">canEditFeaturesFullControl</a></li><li><a href="global.html#canInviteUsers">canInviteUsers</a></li><li><a href="global.html#canJoinNonOrgGroup">canJoinNonOrgGroup</a></li><li><a href="global.html#canJoinOrgGroup">canJoinOrgGroup</a></li><li><a href="global.html#canManageEnterpriseGroups">canManageEnterpriseGroups</a></li><li><a href="global.html#canManageLicenses">canManageLicenses</a></li><li><a href="global.html#canManageMarketplace">canManageMarketplace</a></li><li><a href="global.html#canManageOpenData">canManageOpenData</a></li><li><a href="global.html#canPublishFeatures">canPublishFeatures</a></li><li><a href="global.html#canPublishScenes">canPublishScenes</a></li><li><a href="global.html#canPublishTiles">canPublishTiles</a></li><li><a href="global.html#canPurchaseMarketplace">canPurchaseMarketplace</a></li><li><a href="global.html#canReassignOrgGroups">canReassignOrgGroups</a></li><li><a href="global.html#canReassignOrgItems">canReassignOrgItems</a></li><li><a href="global.html#canShareGroupToOrg">canShareGroupToOrg</a></li><li><a href="global.html#canShareGroupToPublic">canShareGroupToPublic</a></li><li><a href="global.html#canShareItemToGroup">canShareItemToGroup</a></li><li><a href="global.html#canShareItemToOrg">canShareItemToOrg</a></li><li><a href="global.html#canShareItemToPublic">canShareItemToPublic</a></li><li><a href="global.html#canTrialMarketplace">canTrialMarketplace</a></li><li><a href="global.html#canUpdateOrgGroups">canUpdateOrgGroups</a></li><li><a href="global.html#canUpdateOrgItems">canUpdateOrgItems</a></li><li><a href="global.html#canUpdateUsers">canUpdateUsers</a></li><li><a href="global.html#canUseDemographics">canUseDemographics</a></li><li><a href="global.html#canUseElevation">canUseElevation</a></li><li><a href="global.html#canUseGeocode">canUseGeocode</a></li><li><a href="global.html#canUseGeoenrichment">canUseGeoenrichment</a></li><li><a href="global.html#canUseNetworkAnalysis">canUseNetworkAnalysis</a></li><li><a href="global.html#canUseSpatialAnalysis">canUseSpatialAnalysis</a></li><li><a href="global.html#canViewOrgGroups">canViewOrgGroups</a></li><li><a href="global.html#canViewOrgItems">canViewOrgItems</a></li><li><a href="global.html#canViewUsers">canViewUsers</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#constructor">constructor</a></li><li><a href="global.html#coordTextInputKeyWasPressed">coordTextInputKeyWasPressed</a></li><li><a href="global.html#cpBtnWasClicked">cpBtnWasClicked</a></li><li><a href="global.html#cpSubBtnWasClicked">cpSubBtnWasClicked</a></li><li><a href="global.html#createPages">createPages</a></li><li><a href="global.html#deactivateDrawTool">deactivateDrawTool</a></li><li><a href="global.html#destroyOnScreenWidgetsAndGroups">destroyOnScreenWidgetsAndGroups</a></li><li><a href="global.html#drawPointButtonWasClicked">drawPointButtonWasClicked</a></li><li><a href="global.html#expandButtonWasClicked">expandButtonWasClicked</a></li><li><a href="global.html#formatButtonWasClicked">formatButtonWasClicked</a></li><li><a href="global.html#formatDialogApplyButtonClicked">formatDialogApplyButtonClicked</a></li><li><a href="global.html#geomSrvcDidComplete">geomSrvcDidComplete</a></li><li><a href="global.html#geomSrvcDidFail">geomSrvcDidFail</a></li><li><a href="global.html#getCandidateParamNames">getCandidateParamNames</a></li><li><a href="global.html#getCleanInput">getCleanInput</a></li><li><a href="global.html#getCoordValues">getCoordValues</a></li><li><a href="global.html#getCurrentMapCoordinate">getCurrentMapCoordinate</a></li><li><a href="global.html#getDDPoint">getDDPoint</a></li><li><a href="global.html#getExportString">getExportString</a></li><li><a href="global.html#getFormattedCoordinates">getFormattedCoordinates</a></li><li><a href="global.html#getFormattedCoordinateText">getFormattedCoordinateText</a></li><li><a href="global.html#getFormattedDDMStr">getFormattedDDMStr</a></li><li><a href="global.html#getFormattedDDStr">getFormattedDDStr</a></li><li><a href="global.html#getFormattedDMSStr">getFormattedDMSStr</a></li><li><a href="global.html#getFormattedGARSStr">getFormattedGARSStr</a></li><li><a href="global.html#getFormattedGEOREFStr">getFormattedGEOREFStr</a></li><li><a href="global.html#getFormattedMGRSStr">getFormattedMGRSStr</a></li><li><a href="global.html#getFormattedUSNGStr">getFormattedUSNGStr</a></li><li><a href="global.html#getFormattedUTMHStr">getFormattedUTMHStr</a></li><li><a href="global.html#getFormattedUTMStr">getFormattedUTMStr</a></li><li><a href="global.html#getIcon">getIcon</a></li><li><a href="global.html#getMapCoordinateDD">getMapCoordinateDD</a></li><li><a href="global.html#getOrderableInput">getOrderableInput</a></li><li><a href="global.html#getOrderableOutput">getOrderableOutput</a></li><li><a href="global.html#getProjectedPoint">getProjectedPoint</a></li><li><a href="global.html#getStatisticsResult">getStatisticsResult</a></li><li><a href="global.html#getSupportExportFormats">getSupportExportFormats</a></li><li><a href="global.html#getWidgetFilter">getWidgetFilter</a></li><li><a href="global.html#getXYNotation">getXYNotation</a></li><li><a href="global.html#iconClass">iconClass</a></li><li><a href="global.html#iconFormat">iconFormat</a></li><li><a href="global.html#initUI">initUI</a></li><li><a href="global.html#inputError">inputError</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isBasedOnAdmin">isBasedOnAdmin</a></li><li><a href="global.html#isBasedOnPublisher">isBasedOnPublisher</a></li><li><a href="global.html#isBasedOnUser">isBasedOnUser</a></li><li><a href="global.html#isCustom">isCustom</a></li><li><a href="global.html#isFeatureSupported">isFeatureSupported</a></li><li><a href="global.html#isPublisher">isPublisher</a></li><li><a href="global.html#isUser">isUser</a></li><li><a href="global.html#label">label</a></li><li><a href="global.html#loadAndLayout">loadAndLayout</a></li><li><a href="global.html#mapWasClicked">mapWasClicked</a></li><li><a href="global.html#name">name</a></li><li><a href="global.html#nodes">nodes</a></li><li><a href="global.html#onClose">onClose</a></li><li><a href="global.html#onExecute">onExecute</a></li><li><a href="global.html#onMinimize">onMinimize</a></li><li><a href="global.html#onNormalize">onNormalize</a></li><li><a href="global.html#parentWidget">parentWidget</a></li><li><a href="global.html#popupDidClose">popupDidClose</a></li><li><a href="global.html#postCreate">postCreate</a></li><li><a href="global.html#postMixInProperties">postMixInProperties</a></li><li><a href="global.html#print">print</a></li><li><a href="global.html#processCoordTextInput">processCoordTextInput</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#QRCode">QRCode</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#setActions">setActions</a></li><li><a href="global.html#setCoordUI">setCoordUI</a></li><li><a href="global.html#setHidden">setHidden</a></li><li><a href="global.html#setMapLayout">setMapLayout</a></li><li><a href="global.html#setPosition">setPosition</a></li><li><a href="global.html#setPrivileges">setPrivileges</a></li><li><a href="global.html#setReportLayout">setReportLayout</a></li><li><a href="global.html#setSubCoordUI">setSubCoordUI</a></li><li><a href="global.html#setUIListeners">setUIListeners</a></li><li><a href="global.html#setVisible">setVisible</a></li><li><a href="global.html#showToolTip">showToolTip</a></li><li><a href="global.html#statInfo">statInfo</a></li><li><a href="global.html#stringify">stringify</a></li><li><a href="global.html#stringifyPretty">stringifyPretty</a></li><li><a href="global.html#stringifyPrivileges">stringifyPrivileges</a></li><li><a href="global.html#stringifyRole">stringifyRole</a></li><li><a href="global.html#updateDisplay">updateDisplay</a></li><li><a href="global.html#zoomButtonWasClicked">zoomButtonWasClicked</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Thu Dec 31 2020 13:49:27 GMT-0600 (Central Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
